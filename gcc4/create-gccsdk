#!/bin/bash
# Written by John Tytgat <John.Tytgat@aaug.net>
# Copyright (c) 2006 GCCSDK Developers

set -e

pushd `dirname $0` > /dev/null
GCCSDK_ROOT=`pwd`
popd > /dev/null
source $GCCSDK_ROOT/setup-gccsdk-params

if [ -d $GCCSDK_SRCDIR ] ; then
  rm -rf $GCCSDK_SRCDIR
fi
mkdir $GCCSDK_SRCDIR

# Copy original GCC:
cp -r $GCCSDK_GCCORIG/* $GCCSDK_SRCDIR

# Copy a selection of binutils' directories:
cp -r $GCCSDK_BINUTILSORIG/{etc,include,bfd,binutils,cpu,gas,opcodes,ld,gprof,gettext.m4} $GCCSDK_SRCDIR

# 1. Patch it:
pushd $GCCSDK_SRCDIR > /dev/null
for p in `ls $GCCSDK_RECIPE_PATCHES/*.p` ; do
  patch -p0 < $p
done
popd > /dev/null

# 2. Copy full files excluding the .svn directories:
pushd $GCCSDK_RECIPE_FILES > /dev/null
for dir in `find . -type d | grep -v "\.svn" ` ; do mkdir -p $GCCSDK_SRCDIR/$dir ; done
for file in `find . -type f | grep -v "\.svn" ` ; do cp -p $file $GCCSDK_SRCDIR/$file ; done
popd > /dev/null

# 3. Run scripts:
for s in `ls $GCCSDK_RECIPE_SCRIPTS/*` ; do
  . $s
done

# 4. Re-configure for patched configurations not belonging to GCC or UnixLib, i.e. binutils only ATM:
# GCC's configure option --enable-maintainer-mode will take care of GCC/UnixLib configuration changes.
( cd $GCCSDK_SRCDIR/ld && automake-1.9 )
