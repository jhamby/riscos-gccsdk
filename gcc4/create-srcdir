#!/bin/bash
# Written by John Tytgat <John.Tytgat@aaug.net>
# Copyright (c) 2006, 2007 GCCSDK Developers
#
# Combines the contents of gcc, parts of binutils, UnixLib 5.0 and
# SharedCLibrary support into the srcdir directory, does the configuration
# and applies the necessary patches for the arm-unknown-riscos target.

set -e

pushd `dirname $0` > /dev/null
GCCSDK_ROOT=`pwd`
popd > /dev/null
source $GCCSDK_ROOT/setup-gccsdk-params

if [ "x"$1 != "x" ] ; then
  echo "Syntax: create-srcdir"
  exit 1
fi

if [ -d $GCCSDK_SRCDIR ] ; then
  echo "Deleting old $GCCSDK_SRCDIR"
  rm -rf $GCCSDK_SRCDIR
fi
mkdir $GCCSDK_SRCDIR

# Copy original GCC:
echo "Copying original GCC"
cp -a $GCCSDK_GCCORIG/* $GCCSDK_SRCDIR

# Copy a selection of binutils' directories:
echo "Copying original binutils"
cp -a $GCCSDK_BINUTILSORIG/{etc,include,bfd,binutils,cpu,gas,opcodes,ld,gprof,gettext.m4} $GCCSDK_SRCDIR

# 1. Patch it:
pushd $GCCSDK_SRCDIR > /dev/null
for p in `ls $GCCSDK_RECIPE_PATCHES/*.p` ; do
  patch -p0 < $p
done
popd > /dev/null

# 2. Copy full files excluding the .svn directories:
echo "Copying files"
pushd $GCCSDK_RECIPE_FILES > /dev/null
for dir in `find . -type d | grep -v "\.svn" ` ; do mkdir -p $GCCSDK_SRCDIR/$dir ; done
for file in `find . -type f | grep -v "\.svn" ` ; do cp -p $file $GCCSDK_SRCDIR/$file ; done
popd > /dev/null

# 3. Run scripts in alphabetical order:
for s in `ls $GCCSDK_RECIPE_SCRIPTS | sort` ; do
  echo "$GCCSDK_RECIPE_SCRIPTS/$s"
  $GCCSDK_RECIPE_SCRIPTS/$s
done
