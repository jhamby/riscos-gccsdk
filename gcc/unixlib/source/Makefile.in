# Makefile for UnixLib for the ARM/RISC OS GCC port
# Copyright (c) 2000, 2001 Nick Burrett
# Copyright (c) 2004, 2005, 2006 UnixLib Developers
#
# This file is part of UnixLib
#

# These flags exclusively apply to a C compiler
WARNINGSC = -Wstrict-prototypes -Wmissing-prototypes -Wmissing-declarations \
	-Wnested-externs

# Defs for GCC
WARNINGS = -std=c99 -pedantic -Wall -Wundef -Wpointer-arith \
	-Wcast-align -Wwrite-strings -Winline -Wno-unused \
	-W -Wcast-qual -Wshadow $(WARNINGSC)

# C99 mode is required to build UnixLib because the library now contains
# a lot of C99 features.
CROSS_CFLAGS += -D__UNIXLIB_INTERNALS $(WARNINGS) -D_GNU_SOURCE=1 -std=c99 -DRO_ENV=\"$(ro_env)\"

INCLUDES = -isystem clib -I incl-local

libunixobj=$(objdir)/unixlib/$(TRG)

all: unixlib

$(libunixobj)/%.o: %.c
	$(CROSS_CC) $(CROSS_CFLAGS) -o $@ -c $< $(INCLUDES) $(CFL)

$(libunixobj)/%.o: %.s
	$(CROSS_CC) $(CROSS_CFLAGS) -Wa,-pedantic -o $@ -c $< $(CFL)


OBJS = \

HDRS = \

SRCS = \


SUL = $(ro_syspkg)/310/Modules/SharedULib,ffa

MODULE = module/sul.s

unixlib:	$(ux_gcc_bin_dir)/$(TRG)/unixlib.o $(ro_gcc_bin_dir)/$(TRG)/o/unixlib \
	$(ro_unixlibpkg)/source/clib/o/unixlib $(SUL) $(HDRS) $(SRCS)

$(libunixobj)/sys/stackalloc.o: sys/stackalloc.c
	$(CROSS_CC) $(CROSS_CFLAGS) -mno-apcs-stack-check -o $@ -c $< $(INCLUDES) $(CFL)

$(libunixobj)/sys/brk.o: sys/brk.c
	$(CROSS_CC) $(CROSS_CFLAGS) -mno-apcs-stack-check -o $@ -c $< $(INCLUDES) $(CFL)

$(libunixobj)/debug/dvsprintf.o: debug/dvsprintf.c
	$(CROSS_CC) $(CROSS_CFLAGS) -mno-apcs-stack-check -o $@ -c $< $(INCLUDES) $(CFL)


$(ro_gcc_bin_dir)/$(TRG)/o/unixlib $(ro_unixlibpkg)/source/clib/o/unixlib: $(ux_gcc_bin_dir)/$(TRG)/unixlib.o
	cp $< $@


# Use -via to work around Cygwin 16Kbyte command line limit.
$(ux_gcc_bin_dir)/$(TRG)/unixlib.o: $(OBJS) object-list
	$(CROSS_AR) -c $@ -v object-list

# We need to link with drlink not gcc because libgcc may not exist at this point
$(SUL):	$(MODULE)
	$(CROSS_CC) $(CROSS_CFLAGS) -c -o $(libunixobj)/sul.o $(MODULE)
	$(CROSS_LINK) $(libunixobj)/sul.o -quiet -module -o $@

clib/unixlib/buildoptions.s: clib/unixlib/buildoptions.h
	echo "; DO NOT EDIT THIS FILE AS THIS IS A DERIVED FILE !" > $@
	echo "; EDIT buildoptions.h INSTEAD." >> $@
	echo ";" >> $@
	sed  -e "s/\/\*/;/" -e "s/\*\///" -e 's/\#define.*\(__[A-Z0-9_]*\)\(.*\)/\1 EQU \2/' < clib/unixlib/buildoptions.h >> $@
	echo "   END" >> $@

# Dependencies:
