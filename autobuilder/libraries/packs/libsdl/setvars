# This package includes the libraries specified
# in the zipprefix file.
# Ideally depends should also be updated to
# ensure the libraries are built before
# being included in this package

AB_NOREMOTE=yes
AB_ZIPNAME=sdl-0.1
AB_CATEGORY=libraries

# Note: Source zip file is created when the libraries
# are extracted and added to the package

AB_MAKE=":"

# List of libraries for webinfo
sdlliblist=""


ab_package() {
  cp -av $H/\!SDL $D

  FILES=$(cat $H/zipprefix)

  # Need output dir for sources
  mkdir -p $AB_OUTPUTPACK/$AB_CATEGORY
  AB_SRCZIP=$AB_OUTPUTPACK/$AB_CATEGORY/$AB_ZIPNAME-$AB_ROVERSION-src.zip
  addzip -j $AB_SRCZIP $H/ReadMeSrc

  cd $D/\!SDL

  # Get list of libraries
  ls -t -1 $AB_OUTPUTLIB/*.zip > alllibraries

  for FILE in $FILES ; do
     FULLPATH=$( grep -m 1 "$AB_OUTPUTLIB/$FILE" alllibraries )
     echo "Adding $FILE, zip file name $FULLPATH"
     unzip $FULLPATH
     if [ -e abshortdesc ] ; then
       shortdesc=$(cat abshortdesc)
       echo $shortdesc >> $D/\!SDL/\!Help
       rm -f abshortdesc
       sdlliblist="$sdlliblist <li>$shortdesc</li>\n"
     fi
     if [ -d sources ] ; then
        addzip -j $AB_SRCZIP sources/*
        rm -rf sources
     fi
  done

  # Need to retype the converted manual files
  MANFILES=$(find man -type f)
  for FILE in $MANFILES ; do
     mv $FILE $FILE,faf
  done

  rm -f alllibraries
}

# Override ab_webinfo so we can add list of libraries
# to the description
ab_webinfo() {
  . $AB_HOME/build-webinfo
  echo -e " <ul>\n$sdlliblist </ul>\n" >> $AB_OUTPUTPACK/webinfo/$AB_ZIPNAME-$AB_ROVERSION
}
