# Note: We patch Makefile.am.features despite the fact that the file is
# generated by configure and a comment states do not edit. I suspect
# there is a chicken and egg problem here. If the RISC OS specific
# files are not mentioned in this file (as they would not initially
# before configure re-generates the file), then they are ignored for
# the rest of the build.

AB_INSTALL=yes

#export FONTCONFIG_LIBS="-lfontconfig -lfreetype -lexpat -lz"
AB_CONFLAGS="--enable-xlib=no --enable-xlib-xrender=no --enable-xcb=no --enable-xcb-shm=no --enable-png=yes --enable-ft=yes --enable-ps=yes --enable-pdf=yes --enable-svg=yes --enable-tee=yes --enable-qt=no"

ln -T -s -f $H/src.cairo-riscos-sprite-surface.c $S/src/cairo-riscos-sprite-surface.c
ln -T -s -f $H/src.cairo-riscos-memory.c $S/src/cairo-riscos-memory.c
ln -T -s -f $H/src.cairo-riscos.h $S/src/cairo-riscos.h
ln -T -s -f $H/src.cairo-riscos-font.c $S/src/cairo-riscos-font.c
ln -T -s -f $H/boilerplate.cairo-boilerplate-riscos.c $S/boilerplate/cairo-boilerplate-riscos.c

autoreconf -fi

ab_package() {
  ab_create_app LibCairo2 Apps/Library libcairo2-dev

  HERE=`pwd`
  cd $A

  unzip $AB_OUTPUTLIB/$RO_PKG.zip
  
  mv include/cairo cairo
  rm -rf include

  mv lib/*.a .
  rm -rf lib

  mv doc/$RO_PKG/* doc
  rm -rf doc/$RO_PKG

  cd $HERE

  $AB_HOME/add-riscpkg -package "libcairo2-dev" -unixlib -name LibCairo2-Dev \
	-copyrightfile COPYING

  if [ "$RO_SHAREDLIBS" == "yes" ]; then
    ab_create_sharedlib_skeleton libcairo2

    ab_add_sharedlib $S/src/.libs libcairo.so.2
    ab_add_sharedlib $S/util/cairo-script/.libs libcairo-script-interpreter.so.2
    
    if [ -e $S/util/cairo-gobject/.libs/libcairo-gobject.so ]; then
      # libcairo-gobject will only exist if glib was built first.
      ab_add_sharedlib $S/util/cairo-gobject/.libs libcairo-gobject.so.2
    fi

    $AB_HOME/add-riscpkg -package "libcairo2" -name LibCairo2 \
	-depends SharedLibs -depends LibFontConfig1 -depends LibFreeType6 \
	-depends LibPixman-1-0 -depends LibPNG12-0 -suggests UnixFont

    # Don't overwrite the original !SharedLibs.!Boot.
  fi

  if [ -e $S/doc/public/html/index.html ]; then
    ab_create_app LibCairo2 Apps/Library libcairo2-doc

    mkdir -p $A/doc/html
    cp -av $S/doc/public/html/* $A/doc/html

    AB_COMPONENTS=""
    $AB_HOME/add-riscpkg -package "libcairo2-doc" -name LibCairo2-Doc
  fi
}
