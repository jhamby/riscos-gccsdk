#!/bin/bash -e

base=$(dirname $0)

if [ "$1" == "-l" ] ; then
  list=true
  shift
else
  list=false
fi

subdir=$1

if [ -z "$subdir" ] ; then
  subdir=libraries
fi

function getnext() {
  local lib
  local name

  for lib in $(find $base/$subdir -type d) ; do 
    if [ -e $lib/setvars ] && ! [ -e $lib/last-success ] ; then
      if $list; then
        name=$(sed s#$base/## <<< $lib)

        if [ -e $lib/last-depends ] ; then
          echo "$name: $(cat $lib/last-depends)"
        elif [ -e $lib/last-failure ] ; then
          echo "$name: (failed)"
        else
          echo "$name: (not attempted)"
        fi
      else
        basename $lib
        return 0
      fi
    fi
  done
}


if $list; then
  getnext
  exit 0
fi


lib=$(getnext)

while [ -n "$lib" ] ; do

  $base/build -v $lib

  lib=$(getnext)
done

echo "All libraries built"

