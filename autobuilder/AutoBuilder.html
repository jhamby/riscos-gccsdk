<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head><title>Unix Porting Project - Autobuilder Manual</title></head>
<body>


<hr>

<h2>Autobuilder Manual</h2>

<p>Copyright 2003-2005, GCCSDK Developers</a>.</p>
<p>Last updated - 5st July 2005</p>

<hr>

<p></p>

<h3>Purpose</h3>

<p>To automate the mundane and error prone task of repeated builds, updates,
packaging and sundry items of programs and libraries built for the Unix Porting Project.</p>

<p>What the autobuilder does is relatively straightforward, but also complex due to the diverse nature of types of build systems.  Based upon a set of variables set in a configuration file, and optional helper script commands, the autobuilder does the following for a given program:<p>

<ul>
 <li>Fetch the latest version of the source for the package, using Debian's
     <i>apt-get</i> command.  This of course presumes you're using Debian,
     and perform the <i>apt-get update</i> command regularly.  In future,
     we might add CVS fetches and other possibilities, but for now,
     Debian source provides the large majority of sources we might want
     to build.  I would also generally recommend your sources.list file
     refer to Debian <i>testing</i>, at least for sources, as this
     generally reflects the latest released versions from upstream.

 <li>Apply any Debian patches packaged with the source.

 <li>Apply any RISC OS specific patches.

 <li>Run any extra commands required to set up the build correctly.

 <li>Configure the package, with GNU configure or xmkmf, where appropriate.

 <li>Call make on the sources.

 <li>Call make install, if requested.

 <li>Generate HTML from man pages.

 <li>Zip up named files, along with generic ReadMe header.

 <li>Place final package in a location for downloading, etc.
</ul> 


<p></p>

<hr>

<h3>Installation</h3>

<p>The autobuilder is normally placed in /usr/src/autobuilder.  There's a
few hardwired paths, although attempts have been made to avoid them.  Among other things, it assumes the porting tools are in /home/riscos/env, as per the porting tools document.</p>

<p>Under the autobuilder directory are subdirectories for categories of programs, and in those are program directories, although directories can be anywhere under the autobuilder to aid in organisation.   Each program directory contains a "setvars" script, which sets variables used by the autobuilder.</p>

<p></p>

<hr>

<h3>Usage</h3>

<p>To try out the builder, run something like this:</p>

<pre>
   /usr/src/autobuild/build -v cli/whois
</pre>

<p>This will attempt to fetch, build and package the whois program for RISC OS, and place it in the autobuilder's download directory.</p>

<p>The program is built in /tmp/whois, which will be deleted if the build
is successful.  If not, the directory will remain for you to examine the build failure.</p>

<p>The file /usr/src/autobuild/whois/setvars is the file that controls the build.  All these variables are documented in the setvars-template in the top level, so won't be discussed in detail here.</p>


<p>Try:</p>

<pre>
   /usr/src/autobuild/build -v libraries/popt
</pre>

<p>The single line in the setvars file for this library means that "make install" will be run after a successful build.  This means a build environment can be built up under /home/riscos/env.</p>

<p></p>

<hr>

<h3>Other Usage</h3>


<p>The build script accepts several flags:</p>

<ul>
 <li>-v Verbose.  The builder echoes all operations.  Otherwise it generates
     only success/failure output.

 <li>-d Debug.  The temporary directory is not deleted before or at the end of
 the build, even if it was successful.  It will also continue even if applying
 patches fails (to allow for them to be applied already in a previous build).

 <li>-p Package only.  This is for testing the packaging part of the process.  Note that with this option, the autobuilder is unable to determine the version number, so the resulting zip filename will lack this.

 <li>-n No dependencies.  By default the autobuilder will try to build any missing dependencies of the package before building the package itself. This option prevents any dependency checking.

 <li>-f Don't try and fetch the sources.  This allows you to unpack the sources yourself, that you've previously fetched - normally, because you're not on Debian.  To use this, you will need to have a precise setup, because the autobuilder relies on various paths to allow it find things.  Example usage:

  <pre>
  
    mkdir libmng
    cd libmng
    tar xfvz libmng-1.0.0.tgz
    (sources now unpacked into libmng-1.0.0 directory)
    /usr/src/autobuilder/build -v -f libraries/graphics/libmng
  </pre>

</ul>


<p>All other arguments are treated as packages to build.  If none are given, then subdirectories are scanned, and all packages are built.  This is likely to take several hours, but is suitable for daily cron runs.</p> 

<p></p>

<hr>

<h3>Other Output</h3>

<p>If a build fails, then a log of the build - "last-failure" is placed in the package directory.  Upon success, "last-success" is placed in the directory, and any "last-failure" file is deleted.  These files may be examined to determine failures if you don't use the verbose option.</p>

<p>If there is a ReadMe file in the package directory, this is concatenated onto the "header" file and added into the archive. 

<p></p>

<hr>

<h3>Patches</h3>

<p>Any files in a package directory ending in ".p" are applied as patches
   using "patch -p0 -l".</p>

<p>The autobuilder will also look in several standard places for Debian patches, and apply those.</p>

<p></p>

<hr>

<h3>Dependencies</h3>

<p>The autobuilder will attempt to ensure any libraries that a package depends on will be built before the package. It does this by parsing the output of the apt-cache command if available, and the contents of the depends file in the package directory, it it exists. If a dependency has a last-success file in it's package directory then the autobuilder will assume that the dependency is satisfied, if there is no last-success file then it will attempt to build the dependency and fail if it can't.</p>

<p></p>

<hr>

<h3>Programs in Autobuilder</h3>

<p>The majority of programs build, but some may occasionally fail (access to Debian mirrors is not 100%), or changes to a new version, or in a dependent library may cause failures which occasionally need to be addressed.</p>

<p>Please contribute any fixes back to GCCSDK so they can be incorporated.</p>

<p></p>

<hr>

<h3>Other Issues</h3>

<p>Some programs are built, but not packaged or installed.  This gives a warning at the end of the build.   This may be because it has simply not been done yet.  In some cases, "make install" isn't particular appropriate - in particular, I recommend you avoid it for <i>tk</i>.  Instead, it needs to be installed by a custom setup like <i>tcl</i> is.   This allows us to follow Debian conventions with library locations and so forth.</p>

<p>You need a fast connection for this to be useful.  A feature may be added for "static" building.   This would allow building from archives located on a filesystem.  This might also be useful for programs which have not made it to a Debian package yet.</p>

<p></p>

<hr>

</body>
</html>
