AB_MAINTAINER="Peter Naulls <peter@chocky.org>"                                                                    
AB_LICENCE="GPLv2"
AB_ROVERSION=1
AB_PVERSION=0.7.5-svn-$(date +%Y%m%d)

AB_SVN=svn://svn.openttd.org/trunk

(unset CC; unset CXX; ./configure)
make -C objs/lang

rm config.cache
cp objs/lang/endian_check objs/release
cp $H/endian_host.h objs/release

cp -av $H/riscos os

$CC -I$GCCSDK_INSTALL_ENV/include -I$GCCSDK_INSTALL_ENV/include  $GCCSDK_INSTALL_ENV/lib/libOSLib32.a \
 os/riscos/frontend.c os/riscos/rev.c -O2 -o frontend$AB_EXEEXT -static


export CFLAGS=-I/home/riscos/env/include
AB_CONFLAGS="--os=unix --with-zlib=$GCCSDK_INSTALL_ENV/lib/libz.a --prefix-dir=/OpenTTD:
             --data-dir= --without-shared-dir --personal-dir=/OpenTTDChoices:/ --with-freetype=0 --with-fontconfig=0"

ab_package () {
  ab_create_app OpenTTD Apps/Games

  ab_makerun $S/objs/release/openttd $A/\!RunImage $A/Resources/RunGame

  cp -av $S/bin/data/*.grf $A/data/
  cp -av $S/bin/data/*.dat $A/data/
  cp -av $S/bin/data/*.obg $A/data/
  cp -av $S/bin/data/*.obs $A/data/
  cp -av $S/bin/scripts    $A/

  ab_docs docs/Manual.txt docs/multiplayer.txt COPYING known-bugs.txt readme.txt
  cat readme.txt >> $A/\!Help

  cp -av $S/bin/lang/*.lng $A/lang/

  cp -av $S/frontend$AB_EXEEXT $A/Resources/Installer/\!RunImage$AB_EXEEXT

  wget --progress=bar:force http://bundles.openttdcoop.org/opengfx/releases/opengfx-0.2.0.zip -O opengfx.zip
  unzip opengfx.zip
  cp -av opengfx-0.2.0/*.grf opengfx-0.2.0/*.obg $A/data

  wget --progress=bar:force http://bundles.openttdcoop.org/opensfx/releases/opensfx-0.2.0.zip -O opensfx.zip
  mkdir opensfx
  (cd opensfx; unzip ../opensfx.zip)
  tar xfv opensfx/opensfx-0.2.0.tar -C opensfx
  cp -av opensfx/opensfx-0.2.0/*.cat opensfx/opensfx-0.2.0/*.obs $A/data

  $AB_HOME/add-riscpkg -unixlib
}
